<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дизайнер презентаций</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;700&family=Playfair+Display:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        @keyframes fadeInOut {
            0% { opacity: 0; transform: scale(0.8); }
            10% { opacity: 1; transform: scale(1); }
            90% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.8); }
        }
        .animate-fade-in-out {
            animation: fadeInOut 1s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Утилиты для работы с localStorage и проектами
        const ProjectUtils = {
            FORBIDDEN_CHARS: /[\/\\:*?"<>|]/g,
            FORBIDDEN_CHARS_LIST: '/ \\ : * ? " < > |',
            
            // Получить или создать уникальный ID вкладки
            getTabId: () => {
                let tabId = sessionStorage.getItem('presentation_tab_id');
                if (!tabId) {
                    tabId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    sessionStorage.setItem('presentation_tab_id', tabId);
                }
                return tabId;
            },
            
            // Нормализация названия для ключа (замена пробелов на подчёркивания)
            normalizeForKey: (name) => {
                return name.replace(/\s+/g, '_').replace(ProjectUtils.FORBIDDEN_CHARS, '_');
            },
            
            // Проверка на запрещенные символы
            hasInvalidChars: (name) => {
                return ProjectUtils.FORBIDDEN_CHARS.test(name);
            },
            
            // Получить ключ проекта
            getProjectKey: (projectName) => {
                return `presentation_${ProjectUtils.normalizeForKey(projectName)}`;
            },
            
            // Получить ключ сессии
            getSessionKey: (projectName) => {
                return `presentation_session_${ProjectUtils.normalizeForKey(projectName)}`;
            },
            
            // Получить все проекты
            getAllProjects: () => {
                const projects = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('presentation_') && !key.includes('_session_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            if (data && data.projectName) {
                                projects.push({
                                    name: data.projectName,
                                    lastModified: data.lastModified || Date.now(),
                                    slideCount: data.slides ? data.slides.length : 0
                                });
                            }
                        } catch (e) {
                            console.error('Ошибка при чтении проекта:', key, e);
                        }
                    }
                }
                // Сортировка по дате (свежие сверху)
                return projects.sort((a, b) => b.lastModified - a.lastModified);
            },
            
            // Проверка существования проекта (без учета регистра)
            projectExists: (projectName) => {
                const normalized = projectName.toLowerCase().trim();
                const projects = ProjectUtils.getAllProjects();
                return projects.some(p => p.name.toLowerCase().trim() === normalized);
            },
            
            // Загрузка проекта
            loadProject: (projectName) => {
                const key = ProjectUtils.getProjectKey(projectName);
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Ошибка при загрузке проекта:', e);
                    return null;
                }
            },
            
            // Сохранение проекта (без фоновых изображений)
            saveProject: (projectName, data) => {
                const key = ProjectUtils.getProjectKey(projectName);
                
                // Убираем фоновые изображения перед сохранением
                const dataToSave = {
                    ...data,
                    slides: data.slides.map(slide => ({
                        ...slide,
                        bgImage: null  // Не сохраняем изображения
                    })),
                    lastModified: Date.now()
                };
                
                try {
                    const jsonString = JSON.stringify(dataToSave);
                    localStorage.setItem(key, jsonString);
                    return true;
                } catch (e) {
                    console.error('Ошибка при сохранении проекта:', e);
                    return false;
                }
            },
            
            // Удаление проекта
            deleteProject: (projectName) => {
                const key = ProjectUtils.getProjectKey(projectName);
                const sessionKey = ProjectUtils.getSessionKey(projectName);
                try {
                    localStorage.removeItem(key);
                    localStorage.removeItem(sessionKey);
                    return true;
                } catch (e) {
                    console.error('Ошибка при удалении проекта:', e);
                    return false;
                }
            },
            
            // Проверка свободного места
            checkStorageSpace: () => {
                try {
                    const testKey = '_storage_test_';
                    const testData = new Array(1024).join('a'); // ~1KB
                    let available = 0;
                    
                    // Пробуем записать тестовые данные
                    for (let i = 0; i < 10000; i++) {
                        try {
                            localStorage.setItem(testKey + i, testData);
                            available += testData.length;
                        } catch (e) {
                            // Место закончилось
                            break;
                        }
                    }
                    
                    // Очищаем тестовые данные
                    for (let i = 0; i < 10000; i++) {
                        localStorage.removeItem(testKey + i);
                    }
                    
                    return available;
                } catch (e) {
                    return 0;
                }
            },
            
            // Проверка на критически низкое место
            isStorageLow: (lastSaveSize = 150000) => {
                const available = ProjectUtils.checkStorageSpace();
                const threshold = Math.max(lastSaveSize * 1.2, 200000); // 20% запас или минимум 200KB
                return available < threshold;
            },
            
            // Установка блокировки сессии с tabId
            setSessionLock: (projectName) => {
                const sessionKey = ProjectUtils.getSessionKey(projectName);
                const tabId = ProjectUtils.getTabId();
                const sessionData = {
                    tabId: tabId,
                    timestamp: Date.now()
                };
                localStorage.setItem(sessionKey, JSON.stringify(sessionData));
                return tabId;
            },
            
            // Проверка блокировки сессии с учётом tabId
            checkSessionLock: (projectName, currentTabId) => {
                const sessionKey = ProjectUtils.getSessionKey(projectName);
                const storedData = localStorage.getItem(sessionKey);
                
                if (!storedData) {
                    return false; // Нет блокировки
                }
                
                try {
                    const sessionData = JSON.parse(storedData);
                    // Если tabId совпадает - это та же вкладка (даже после перезагрузки)
                    return sessionData.tabId !== currentTabId;
                } catch (e) {
                    // Если не удалось распарсить, считаем что блокировка есть
                    return true;
                }
            },
            
            // Снятие блокировки сессии
            releaseSessionLock: (projectName) => {
                const sessionKey = ProjectUtils.getSessionKey(projectName);
                localStorage.removeItem(sessionKey);
            },
            
            // Форматирование даты по московскому времени
            formatDate: (timestamp) => {
                const date = new Date(timestamp);
                // Конвертируем в московское время (UTC+3)
                const moscowOffset = 3 * 60; // минуты
                const localOffset = date.getTimezoneOffset(); // минуты
                const moscowTime = new Date(date.getTime() + (moscowOffset + localOffset) * 60000);
                
                const day = String(moscowTime.getDate()).padStart(2, '0');
                const month = String(moscowTime.getMonth() + 1).padStart(2, '0');
                const year = moscowTime.getFullYear();
                const hours = String(moscowTime.getHours()).padStart(2, '0');
                const minutes = String(moscowTime.getMinutes()).padStart(2, '0');
                
                return `${day}.${month}.${year}, ${hours}:${minutes}`;
            }
        };

        const PresentationDesigner = () => {
            const [mode, setMode] = useState('projectSelect'); // projectSelect, import, edit
            const [projectName, setProjectName] = useState('');
            const [sessionId, setSessionId] = useState(null);
            const [slides, setSlides] = useState([]);
            const [currentSlideIndex, setCurrentSlideIndex] = useState(0);
            const [changedSettings, setChangedSettings] = useState({});
            const [isStyleSectionOpen, setIsStyleSectionOpen] = useState(false);
            const [aspectRatio, setAspectRatio] = useState('16:9');
            const [showImageModal, setShowImageModal] = useState(false);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [pendingImage, setPendingImage] = useState(null);
            const [isExporting, setIsExporting] = useState(false);
            const [exportProgress, setExportProgress] = useState(0);
            
            // Новые состояния для управления проектами
            const [allProjects, setAllProjects] = useState([]);
            const [showAllProjects, setShowAllProjects] = useState(false);
            const [showNewProjectModal, setShowNewProjectModal] = useState(false);
            const [newProjectName, setNewProjectName] = useState('');
            const [newProjectError, setNewProjectError] = useState('');
            const [showConfirmCreate, setShowConfirmCreate] = useState(false);
            const [showConfirmDelete, setShowConfirmDelete] = useState(false);
            const [projectToDelete, setProjectToDelete] = useState('');
            const [showStorageWarning, setShowStorageWarning] = useState(false);
            const [showSessionWarning, setShowSessionWarning] = useState(false);
            const [lastSaveTime, setLastSaveTime] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [showConfirmDeleteSlide, setShowConfirmDeleteSlide] = useState(false);
            const [slideToDelete, setSlideToDelete] = useState(null);
            const [showInstructions, setShowInstructions] = useState(false);
            
            const slideRef = useRef(null);
            const importTextRef = useRef(null);
            const fileInputRef = useRef(null);
            const importProjectFileRef = useRef(null);
            const autoSaveIntervalRef = useRef(null);

            // Загрузка списка проектов при монтировании
            useEffect(() => {
                loadProjectsList();
            }, []);

            // Автосохранение каждые 30 секунд
            useEffect(() => {
                if (mode === 'edit' && slides.length > 0 && projectName) {
                    // Проверяем блокировку сессии перед каждым автосохранением
                    if (sessionId && ProjectUtils.checkSessionLock(projectName, sessionId)) {
                        setShowSessionWarning(true);
                        return;
                    }
                    
                    autoSaveIntervalRef.current = setInterval(() => {
                        autoSaveProject();
                    }, 30000); // 30 секунд

                    return () => {
                        if (autoSaveIntervalRef.current) {
                            clearInterval(autoSaveIntervalRef.current);
                        }
                    };
                }
            }, [mode, slides, projectName, aspectRatio, currentSlideIndex, sessionId]);

            // Открытие секции оформления на первом слайде
            useEffect(() => {
                if (mode === 'edit') {
                    setIsStyleSectionOpen(currentSlideIndex === 0);
                }
            }, [mode, currentSlideIndex]);

            // Снятие блокировки при закрытии страницы
            useEffect(() => {
                const handleBeforeUnload = () => {
                    if (projectName && sessionId) {
                        ProjectUtils.releaseSessionLock(projectName);
                    }
                };
                
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => {
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                    if (projectName && sessionId) {
                        ProjectUtils.releaseSessionLock(projectName);
                    }
                };
            }, [projectName, sessionId]);

            const fonts = [
                { name: 'Inter', value: 'Inter, sans-serif' },
                { name: 'Roboto', value: 'Roboto, sans-serif' },
                { name: 'Playfair Display', value: 'Playfair Display, serif' },
                { name: 'Montserrat', value: 'Montserrat, sans-serif' },
                { name: 'Open Sans', value: 'Open Sans, sans-serif' }
            ];

            const loadProjectsList = () => {
                const projects = ProjectUtils.getAllProjects();
                setAllProjects(projects);
            };

            const autoSaveProject = () => {
                if (!projectName || slides.length === 0) return;
                
                // Проверяем свободное место
                if (ProjectUtils.isStorageLow()) {
                    setShowStorageWarning(true);
                    return;
                }
                
                setIsSaving(true);
                
                const projectData = {
                    projectName,
                    aspectRatio,
                    currentSlideIndex,
                    slides
                };
                
                const success = ProjectUtils.saveProject(projectName, projectData);
                
                if (success) {
                    setLastSaveTime(Date.now());
                }
                
                // Скрываем индикатор через 1 секунду
                setTimeout(() => setIsSaving(false), 1000);
            };

            const handleCreateNewProject = () => {
                setNewProjectName('');
                setNewProjectError('');
                setShowNewProjectModal(true);
            };

            const handleNewProjectNameChange = (value) => {
                setNewProjectName(value);
                
                if (value.trim() === '') {
                    setNewProjectError('');
                    return;
                }
                
                if (ProjectUtils.hasInvalidChars(value)) {
                    setNewProjectError(`Название не должно содержать символы: ${ProjectUtils.FORBIDDEN_CHARS_LIST}`);
                    return;
                }
                
                if (ProjectUtils.projectExists(value)) {
                    setNewProjectError('Проект с таким названием уже существует. Выберите другое название.');
                    return;
                }
                
                setNewProjectError('');
            };

            const handleConfirmNewProject = () => {
                if (newProjectName.trim() === '') {
                    setNewProjectError('Введите название проекта');
                    return;
                }
                
                if (newProjectError) return;
                
                setShowNewProjectModal(false);
                setShowConfirmCreate(true);
            };

            const handleFinalCreateProject = () => {
                setProjectName(newProjectName.trim());
                const tabId = ProjectUtils.setSessionLock(newProjectName.trim());
                setSessionId(tabId);
                setShowConfirmCreate(false);
                setMode('import');
            };

            const handleContinueProject = (name) => {
                // Получаем tabId текущей вкладки
                const currentTabId = ProjectUtils.getTabId();
                
                // Проверяем блокировку сессии
                if (ProjectUtils.checkSessionLock(name, currentTabId)) {
                    // Устанавливаем имя проекта для экспорта в модальном окне
                    setProjectName(name);
                    setShowSessionWarning(true);
                    return;
                }
                
                const projectData = ProjectUtils.loadProject(name);
                if (projectData) {
                    setProjectName(name);
                    const tabId = ProjectUtils.setSessionLock(name);
                    setSessionId(tabId);
                    setAspectRatio(projectData.aspectRatio || '16:9');
                    setCurrentSlideIndex(projectData.currentSlideIndex || 0);
                    
                    // Восстанавливаем слайды, помечая отсутствие фоновых изображений
                    const restoredSlides = projectData.slides.map(slide => ({
                        ...slide,
                        bgImage: null,
                        bgType: slide.bgType === 'image' ? 'solid' : slide.bgType
                    }));
                    
                    setSlides(restoredSlides);
                    setMode('edit');
                }
            };

            const handleDeleteProject = (name) => {
                setProjectToDelete(name);
                setShowConfirmDelete(true);
            };

            const handleConfirmDeleteProject = () => {
                if (projectToDelete) {
                    ProjectUtils.deleteProject(projectToDelete);
                    loadProjectsList();
                    setShowConfirmDelete(false);
                    setProjectToDelete('');
                }
            };

            const handleExportProjectFromList = (projectNameToExport) => {
                const projectData = ProjectUtils.loadProject(projectNameToExport);
                if (!projectData) {
                    alert('Не удалось загрузить проект для экспорта.');
                    return;
                }
                
                const jsonString = JSON.stringify(projectData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const safeProjectName = getSafeFileName(projectNameToExport);
                link.download = `${safeProjectName}_backup.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleBackToProjects = () => {
                // Сохраняем перед выходом
                if (slides.length > 0) {
                    autoSaveProject();
                }
                
                // Снимаем блокировку
                if (projectName && sessionId) {
                    ProjectUtils.releaseSessionLock(projectName);
                }
                
                setMode('projectSelect');
                setProjectName('');
                setSessionId(null);
                setSlides([]);
                setCurrentSlideIndex(0);
                loadProjectsList();
            };

            const markSettingChanged = (settingName) => {
                setChangedSettings(prev => ({
                    ...prev,
                    [settingName]: true
                }));
            };

            const clearSettingChange = (settingName) => {
                setChangedSettings(prev => {
                    const newState = { ...prev };
                    delete newState[settingName];
                    return newState;
                });
            };

            const applyToCurrentSlide = (settings) => {
                const updatedSlides = [...slides];
                updatedSlides[currentSlideIndex] = {
                    ...updatedSlides[currentSlideIndex],
                    ...settings
                };
                setSlides(updatedSlides);
            };

            const applyToCurrentAndFollowing = (settings) => {
                const updatedSlides = slides.map((slide, index) => {
                    if (index >= currentSlideIndex) {
                        return { ...slide, ...settings };
                    }
                    return slide;
                });
                setSlides(updatedSlides);
            };

            const applyToAllSlides = (settings) => {
                const updatedSlides = slides.map(slide => ({
                    ...slide,
                    ...settings
                }));
                setSlides(updatedSlides);
            };

            const parseSlides = (text) => {
                const slidePattern = /^(\d+)\s*$/gm;
                const parts = text.split(slidePattern).filter(part => part.trim() !== '');
                
                const parsedSlides = [];
                
                for (let i = 0; i < parts.length; i += 2) {
                    if (i + 1 < parts.length) {
                        const content = parts[i].trim();
                        const slideNumber = parts[i + 1];
                        
                        const lines = content.split('\n').filter(line => line.trim() !== '');
                        
                        let title = '';
                        let mainText = '';
                        let accentText = '';
                        let secondaryText = '';
                        
                        if (lines.length > 0) {
                            title = lines[0];
                            
                            let accentIndex = -1;
                            for (let j = 1; j < lines.length; j++) {
                                if (lines[j].trim().endsWith(':')) {
                                    accentText = lines[j];
                                    accentIndex = j;
                                    break;
                                }
                            }
                            
                            if (accentIndex > 0) {
                                mainText = lines.slice(1, accentIndex).join('\n');
                                if (accentIndex < lines.length - 1) {
                                    secondaryText = lines.slice(accentIndex + 1).join('\n');
                                }
                            } else {
                                mainText = lines.slice(1).join('\n');
                            }
                        }
                        
                        parsedSlides.push({
                            id: slideNumber,
                            title: title,
                            mainText: mainText,
                            accentText: accentText,
                            secondaryText: secondaryText,
                            titleAlign: 'left',
                            mainTextAlign: 'left',
                            accentAlign: 'left',
                            secondaryTextAlign: 'left',
                            bgType: 'solid',
                            bgColor1: '#1e40af',
                            bgColor2: '#7c3aed',
                            bgImage: null,
                            fontFamily: 'Inter',
                            titleFontSize: 130,
                            mainFontSize: 75,
                            accentFontSize: 70,
                            accentBgColor: '#fbbf24',
                            textColor: '#ffffff',
                            accentTextColor: '#000000'
                        });
                    }
                }
                
                return parsedSlides;
            };

            const handleImport = () => {
                const text = importTextRef.current.value;
                if (text.trim()) {
                    const parsedSlides = parseSlides(text);
                    setSlides(parsedSlides);
                    setMode('edit');
                    setCurrentSlideIndex(0);
                    
                    // Первое сохранение сразу после импорта
                    setTimeout(() => {
                        const projectData = {
                            projectName,
                            aspectRatio,
                            currentSlideIndex: 0,
                            slides: parsedSlides
                        };
                        ProjectUtils.saveProject(projectName, projectData);
                        setLastSaveTime(Date.now());
                    }, 1000);
                }
            };

            const updateCurrentSlide = (field, value) => {
                const updatedSlides = [...slides];
                updatedSlides[currentSlideIndex] = {
                    ...updatedSlides[currentSlideIndex],
                    [field]: value
                };
                setSlides(updatedSlides);
            };

            const createNewSlide = () => {
                const newSlide = {
                    id: String(slides.length + 1),
                    title: '',
                    mainText: '',
                    accentText: '',
                    secondaryText: '',
                    titleAlign: 'left',
                    mainTextAlign: 'left',
                    accentAlign: 'left',
                    secondaryTextAlign: 'left',
                    bgType: currentSlide.bgType || 'solid',
                    bgColor1: currentSlide.bgColor1 || '#1e40af',
                    bgColor2: currentSlide.bgColor2 || '#7c3aed',
                    bgImage: null,
                    fontFamily: currentSlide.fontFamily || 'Inter',
                    titleFontSize: currentSlide.titleFontSize || 130,
                    mainFontSize: currentSlide.mainFontSize || 75,
                    accentFontSize: currentSlide.accentFontSize || 70,
                    accentBgColor: currentSlide.accentBgColor || '#fbbf24',
                    textColor: currentSlide.textColor || '#ffffff',
                    accentTextColor: currentSlide.accentTextColor || '#000000'
                };
                
                const updatedSlides = [...slides];
                updatedSlides.splice(currentSlideIndex + 1, 0, newSlide);
                
                // Обновляем ID слайдов
                updatedSlides.forEach((slide, index) => {
                    slide.id = String(index + 1);
                });
                
                setSlides(updatedSlides);
                setCurrentSlideIndex(currentSlideIndex + 1);
            };

            const handleDeleteSlideRequest = () => {
                setSlideToDelete(currentSlideIndex);
                setShowConfirmDeleteSlide(true);
            };

            const handleConfirmDeleteSlide = () => {
                if (slides.length <= 1) {
                    alert('Нельзя удалить последний слайд в презентации.');
                    setShowConfirmDeleteSlide(false);
                    return;
                }
                
                const updatedSlides = slides.filter((_, index) => index !== slideToDelete);
                
                // Обновляем ID слайдов
                updatedSlides.forEach((slide, index) => {
                    slide.id = String(index + 1);
                });
                
                setSlides(updatedSlides);
                
                // Корректируем текущий индекс
                if (slideToDelete === slides.length - 1) {
                    setCurrentSlideIndex(Math.max(0, slideToDelete - 1));
                } else {
                    setCurrentSlideIndex(Math.min(slideToDelete, updatedSlides.length - 1));
                }
                
                setShowConfirmDeleteSlide(false);
                setSlideToDelete(null);
            };

            const exportProjectToFile = () => {
                const projectData = {
                    projectName,
                    aspectRatio,
                    currentSlideIndex,
                    slides,
                    exportDate: Date.now(),
                    version: '1.0'
                };
                
                const jsonString = JSON.stringify(projectData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const safeProjectName = getSafeFileName(projectName);
                link.download = `${safeProjectName}_project.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleImportProjectFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const projectData = JSON.parse(e.target.result);
                        
                        // Валидация данных
                        if (!projectData.projectName || !projectData.slides || !Array.isArray(projectData.slides)) {
                            alert('Неверный формат файла проекта.');
                            return;
                        }
                        
                        // Проверяем, существует ли проект с таким именем
                        if (ProjectUtils.projectExists(projectData.projectName)) {
                            const confirmOverwrite = window.confirm(
                                `Проект "${projectData.projectName}" уже существует в локальном хранилище. Загрузить проект из файла?`
                            );
                            if (!confirmOverwrite) {
                                return;
                            }
                        }
                        
                        // Загружаем проект
                        setProjectName(projectData.projectName);
                        const tabId = ProjectUtils.setSessionLock(projectData.projectName);
                        setSessionId(tabId);
                        setAspectRatio(projectData.aspectRatio || '16:9');
                        setCurrentSlideIndex(projectData.currentSlideIndex || 0);
                        setSlides(projectData.slides);
                        setMode('edit');
                        
                        // Сохраняем в localStorage
                        ProjectUtils.saveProject(projectData.projectName, projectData);
                        
                    } catch (error) {
                        console.error('Ошибка при импорте проекта:', error);
                        alert('Не удалось загрузить проект. Проверьте файл и попробуйте снова.');
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Сброс input
            };

            const currentSlide = slides[currentSlideIndex] || {};

            const getSlideBackground = () => {
                const bgType = currentSlide.bgType || 'solid';
                const bgImage = currentSlide.bgImage;
                const bgColor1 = currentSlide.bgColor1 || '#1e40af';
                const bgColor2 = currentSlide.bgColor2 || '#7c3aed';
                
                if (bgType === 'image' && bgImage) {
                    return {
                        backgroundImage: `url(${bgImage})`,
                        backgroundSize: 'cover',
                        backgroundPosition: 'center',
                        backgroundRepeat: 'no-repeat'
                    };
                } else if (bgType === 'solid') {
                    return { backgroundColor: bgColor1 };
                } else {
                    return {
                        backgroundImage: `linear-gradient(135deg, ${bgColor1} 0%, ${bgColor2} 100%)`
                    };
                }
            };

            const handleImageSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setPendingImage(event.target.result);
                        setShowImageModal(true);
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = '';
            };

            const applyImageToCurrentSlide = () => {
                const settings = {
                    bgImage: pendingImage,
                    bgType: 'image'
                };
                applyToCurrentSlide(settings);
                setShowImageModal(false);
                setPendingImage(null);
            };

            const applyImageToAllSlides = () => {
                const settings = {
                    bgImage: pendingImage,
                    bgType: 'image'
                };
                applyToAllSlides(settings);
                setShowImageModal(false);
                setPendingImage(null);
            };

            const applyImageToFollowingSlides = () => {
                const settings = {
                    bgImage: pendingImage,
                    bgType: 'image'
                };
                applyToCurrentAndFollowing(settings);
                setShowImageModal(false);
                setPendingImage(null);
            };

            const cancelImageUpload = () => {
                setShowImageModal(false);
                setPendingImage(null);
            };

            const removeBackgroundImage = (applyTo) => {
                const settings = {
                    bgImage: null,
                    bgType: 'solid'
                };
                if (applyTo === 'all') {
                    applyToAllSlides(settings);
                } else if (applyTo === 'following') {
                    applyToCurrentAndFollowing(settings);
                } else {
                    applyToCurrentSlide(settings);
                }
            };

            const getAspectRatioClass = () => {
                switch(aspectRatio) {
                    case '16:9':
                        return 'aspect-video';
                    case '1:1':
                        return 'aspect-square';
                    case '4:3':
                        return 'aspect-[4/3]';
                    default:
                        return 'aspect-video';
                }
            };

            const getCanvasDimensions = () => {
                switch(aspectRatio) {
                    case '16:9':
                        return { width: 1920, height: 1080 };
                    case '1:1':
                        return { width: 1080, height: 1080 };
                    case '4:3':
                        return { width: 1440, height: 1080 };
                    default:
                        return { width: 1920, height: 1080 };
                }
            };

            const getSafeFileName = (name) => {
                return name.replace(/\s+/g, '_').replace(ProjectUtils.FORBIDDEN_CHARS, '_');
            };

            const AlignmentToggle = ({ value, onChange }) => {
                return (
                    <div className="flex gap-1 bg-gray-100 p-1 rounded-md">
                        <button
                            onClick={() => onChange('left')}
                            className={`px-3 py-1 rounded transition-colors ${
                                value === 'left' 
                                    ? 'bg-white shadow-sm text-blue-600' 
                                    : 'hover:bg-gray-50 text-gray-600'
                            }`}
                            title="По левому краю"
                        >
                            ←
                        </button>
                        <button
                            onClick={() => onChange('center')}
                            className={`px-3 py-1 rounded transition-colors ${
                                value === 'center' 
                                    ? 'bg-white shadow-sm text-blue-600' 
                                    : 'hover:bg-gray-50 text-gray-600'
                            }`}
                            title="По центру"
                        >
                            ↔
                        </button>
                    </div>
                );
            };

            const FontSizeSlider = ({ label, value, onChange, min, max }) => {
                return (
                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <label className="block text-sm font-medium text-gray-600">
                                {label}
                            </label>
                            <span className="text-sm font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                {value}px
                            </span>
                        </div>
                        <input
                            type="range"
                            min={min}
                            max={max}
                            value={value}
                            onChange={(e) => onChange(parseInt(e.target.value))}
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                        />
                        <div className="flex justify-between text-xs text-gray-400 mt-1">
                            <span>{min}px</span>
                            <span>{max}px</span>
                        </div>
                    </div>
                );
            };

            const ApplyButtons = ({ onApplyCurrent, onApplyAll, settingKey, settingName }) => {
                if (!changedSettings[settingKey]) return null;
                
                return (
                    <div className="mt-3 p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg border-2 border-amber-400 shadow-lg">
                        <p className="text-sm text-gray-800 mb-3 font-semibold flex items-center gap-2">
                            <span className="inline-block w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                            Применить {settingName || 'изменения'}?
                        </p>
                        <div className="space-y-2">
                            <div className="flex gap-2">
                                <button
                                    onClick={() => {
                                        onApplyCurrent();
                                        clearSettingChange(settingKey);
                                    }}
                                    className="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all text-sm font-semibold shadow-md hover:shadow-lg transform hover:scale-105"
                                >
                                    Только этот слайд
                                </button>
                                <button
                                    onClick={() => {
                                        onApplyAll();
                                        clearSettingChange(settingKey);
                                    }}
                                    className="flex-1 px-4 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all text-sm font-semibold shadow-md hover:shadow-lg transform hover:scale-105"
                                >
                                    Этот и следующие
                                </button>
                            </div>
                            <button
                                onClick={() => clearSettingChange(settingKey)}
                                className="w-full px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium border border-gray-300"
                            >
                                Не применять
                            </button>
                        </div>
                    </div>
                );
            };

            const renderSlideToCanvas = async (slide, slideIndex) => {
                const originalIndex = currentSlideIndex;
                setCurrentSlideIndex(slideIndex);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (!slideRef.current) return null;
                
                try {
                    const dimensions = getCanvasDimensions();
                    const scale = dimensions.width / slideRef.current.offsetWidth;
                    
                    const canvas = await html2canvas(slideRef.current, {
                        scale: scale,
                        width: slideRef.current.offsetWidth,
                        height: slideRef.current.offsetHeight,
                        backgroundColor: null,
                        logging: false,
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    setCurrentSlideIndex(originalIndex);
                    return canvas;
                } catch (error) {
                    console.error('Ошибка при рендере слайда:', error);
                    setCurrentSlideIndex(originalIndex);
                    return null;
                }
            };

            const exportCurrentSlide = async () => {
                if (!slideRef.current) return;
                
                try {
                    const dimensions = getCanvasDimensions();
                    const scale = dimensions.width / slideRef.current.offsetWidth;
                    
                    const canvas = await html2canvas(slideRef.current, {
                        scale: scale,
                        width: slideRef.current.offsetWidth,
                        height: slideRef.current.offsetHeight,
                        backgroundColor: null,
                        logging: false,
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        const safeProjectName = getSafeFileName(projectName);
                        link.download = `${safeProjectName}_slide_${currentSlide.id || currentSlideIndex + 1}.png`;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);
                    });
                } catch (error) {
                    console.error('Ошибка при экспорте:', error);
                    alert('Произошла ошибка при экспорте. Попробуйте еще раз.');
                }
            };

            const exportAllSlidesAsZip = async () => {
                setIsExporting(true);
                setExportProgress(0);
                
                try {
                    const zip = new JSZip();
                    const folder = zip.folder('slides');
                    
                    for (let i = 0; i < slides.length; i++) {
                        setExportProgress(Math.round(((i + 1) / slides.length) * 100));
                        
                        const canvas = await renderSlideToCanvas(slides[i], i);
                        if (canvas) {
                            const blob = await new Promise(resolve => canvas.toBlob(resolve));
                            folder.file(`slide-${slides[i].id || i + 1}.png`, blob);
                        }
                    }
                    
                    const content = await zip.generateAsync({ type: 'blob' });
                    const url = URL.createObjectURL(content);
                    const link = document.createElement('a');
                    const safeProjectName = getSafeFileName(projectName);
                    link.download = `${safeProjectName}_all_slides.zip`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                } catch (error) {
                    console.error('Ошибка при экспорте ZIP:', error);
                    alert('Произошла ошибка при создании архива. Попробуйте еще раз.');
                } finally {
                    setIsExporting(false);
                    setExportProgress(0);
                }
            };

            const exportAllSlidesAsPDF = async () => {
                setIsExporting(true);
                setExportProgress(0);
                
                try {
                    const dimensions = getCanvasDimensions();
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: dimensions.width > dimensions.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [dimensions.width, dimensions.height]
                    });
                    
                    for (let i = 0; i < slides.length; i++) {
                        setExportProgress(Math.round(((i + 1) / slides.length) * 100));
                        
                        const canvas = await renderSlideToCanvas(slides[i], i);
                        if (canvas) {
                            const imgData = canvas.toDataURL('image/png');
                            
                            if (i > 0) {
                                pdf.addPage([dimensions.width, dimensions.height]);
                            }
                            
                            pdf.addImage(imgData, 'PNG', 0, 0, dimensions.width, dimensions.height);
                        }
                    }
                    
                    const safeProjectName = getSafeFileName(projectName);
                    pdf.save(`${safeProjectName}_all_slides.pdf`);
                    
                } catch (error) {
                    console.error('Ошибка при экспорте PDF:', error);
                    alert('Произошла ошибка при создании PDF. Попробуйте еще раз.');
                } finally {
                    setIsExporting(false);
                    setExportProgress(0);
                }
            };

            // Модальные окна
            const NewProjectModal = () => {
                if (!showNewProjectModal) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                    Создать новый проект
                                </h2>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Название проекта
                                    </label>
                                    <input
                                        type="text"
                                        value={newProjectName}
                                        onChange={(e) => handleNewProjectNameChange(e.target.value)}
                                        placeholder="Например: Курс КПТ. Модуль 1. Урок 1"
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        autoFocus
                                    />
                                    {newProjectError && (
                                        <p className="mt-2 text-sm text-red-600">
                                            {newProjectError}
                                        </p>
                                    )}
                                </div>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowNewProjectModal(false)}
                                        className="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                                    >
                                        Отмена
                                    </button>
                                    <button
                                        onClick={handleConfirmNewProject}
                                        disabled={!newProjectName.trim() || !!newProjectError}
                                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-semibold"
                                    >
                                        Далее
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const ConfirmCreateModal = () => {
                if (!showConfirmCreate) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                    Подтверждение
                                </h2>
                                
                                <p className="text-gray-600 mb-6">
                                    Создать проект <span className="font-semibold">"{newProjectName}"</span>?
                                </p>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowConfirmCreate(false)}
                                        className="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                                    >
                                        Отмена
                                    </button>
                                    <button
                                        onClick={handleFinalCreateProject}
                                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                    >
                                        Создать
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const ConfirmDeleteModal = () => {
                if (!showConfirmDelete) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                    Удалить проект?
                                </h2>
                                
                                <p className="text-gray-600 mb-6">
                                    Вы уверены? Локальная сохранённая версия проекта <span className="font-semibold">"{projectToDelete}"</span> будет удалена с этого устройства.
                                </p>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowConfirmDelete(false)}
                                        className="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                                    >
                                        Отмена
                                    </button>
                                    <button
                                        onClick={handleConfirmDeleteProject}
                                        className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold"
                                    >
                                        Удалить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const ConfirmDeleteSlideModal = () => {
                if (!showConfirmDeleteSlide) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2">
                                    ⚠️ Удалить слайд?
                                </h2>
                                
                                <p className="text-gray-600 mb-6">
                                    Вы уверены, что хотите удалить <span className="font-semibold">слайд №{slideToDelete + 1}</span>? Это действие нельзя отменить.
                                </p>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowConfirmDeleteSlide(false);
                                            setSlideToDelete(null);
                                        }}
                                        className="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                                    >
                                        Отмена
                                    </button>
                                    <button
                                        onClick={handleConfirmDeleteSlide}
                                        className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold"
                                    >
                                        Удалить слайд
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const StorageWarningModal = () => {
                if (!showStorageWarning) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2">
                                    ⚠️ Память заполнена
                                </h2>
                                
                                <p className="text-gray-600 mb-4">
                                    Место в локальном хранилище браузера заканчивается.
                                </p>
                                
                                <p className="text-gray-600 mb-6">
                                    Вернитесь к списку проектов и удалите завершённые проекты, чтобы освободить место. Если это единственный проект, сохраните текущую работу и разделите её на части.
                                </p>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowStorageWarning(false)}
                                        className="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                                    >
                                        Понятно
                                    </button>
                                    <button
                                        onClick={handleBackToProjects}
                                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                    >
                                        К списку проектов
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const SessionWarningModal = () => {
                if (!showSessionWarning) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold text-orange-600 mb-4 flex items-center gap-2">
                                    ⚠️ Проект редактируется в другой вкладке
                                </h2>
                                
                                <p className="text-gray-600 mb-4">
                                    Проект "<span className="font-semibold">{projectName}</span>" уже открыт в другой вкладке браузера. Изменения не будут сохраняться, чтобы избежать конфликтов данных.
                                </p>
                                
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                    <p className="text-sm text-gray-700 font-semibold mb-2">
                                        💡 Если вы не можете найти другую вкладку или считаете, что произошла ошибка:
                                    </p>
                                    <ol className="text-sm text-gray-600 space-y-1 list-decimal list-inside ml-2">
                                        <li>Нажмите кнопку "Скачать резервную копию" ниже</li>
                                        <li>Закройте это окно и удалите проект из списка</li>
                                        <li>Нажмите "Загрузить проект с диска"</li>
                                        <li>Выберите скачанный файл резервной копии</li>
                                    </ol>
                                </div>
                                
                                <div className="space-y-3">
                                    <button
                                        onClick={() => {
                                            handleExportProjectFromList(projectName);
                                        }}
                                        className="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold flex items-center justify-center gap-2"
                                    >
                                        💾 Скачать резервную копию
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            setShowSessionWarning(false);
                                            setProjectName('');
                                        }}
                                        className="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                                    >
                                        Закрыть
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const InstructionsModal = () => {
                if (!showInstructions) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                        <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full my-8">
                            <div className="sticky top-0 bg-white border-b border-gray-200 rounded-t-xl px-6 py-4 flex items-center justify-between">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    📖 Как пользоваться сервисом
                                </h2>
                                <button
                                    onClick={() => setShowInstructions(false)}
                                    className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
                                >
                                    ✕
                                </button>
                            </div>
                            
                            <div className="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                    <p className="text-gray-700 font-semibold mb-2">
                                        👋 Добро пожаловать в Дизайнер презентаций!
                                    </p>
                                    <p className="text-gray-600 text-sm">
                                        Этот сервис поможет вам быстро создать красивые слайды для презентаций. Следуйте простой инструкции ниже — всё очень просто!
                                    </p>
                                </div>

                                <div className="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
                                    <p className="text-orange-800 font-bold mb-2 flex items-center gap-2">
                                        ⚠️ Важно! Рекомендуемый размер презентации
                                    </p>
                                    <div className="text-gray-700 text-sm space-y-2">
                                        <p>
                                            <span className="font-semibold text-green-700">✅ Оптимально: до 50 слайдов</span> — всё работает быстро и стабильно
                                        </p>
                                        <p>
                                            <span className="font-semibold text-yellow-700">⚠️ Допустимо: 50-80 слайдов</span> — может работать медленнее при экспорте
                                        </p>
                                        <p>
                                            <span className="font-semibold text-red-700">❌ Не рекомендуется: более 80 слайдов</span> — возможны проблемы с сохранением и экспортом, браузер может зависнуть
                                        </p>
                                        <p className="mt-3 bg-white p-2 rounded border border-orange-200">
                                            💡 <span className="font-semibold">Совет:</span> Если у вас большая презентация (100+ слайдов), разделите её на несколько частей. Например: "Курс КПТ — Часть 1", "Курс КПТ — Часть 2" и т.д.
                                        </p>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        🎯 Шаг 1: Создайте проект
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg space-y-2 text-gray-700">
                                        <p>• Нажмите кнопку <span className="font-semibold text-blue-600">"Создать новый проект"</span></p>
                                        <p>• Введите название вашей презентации (например: "Урок по психологии")</p>
                                        <p>• Нажмите "Далее" и подтвердите создание</p>
                                        <p className="text-sm text-gray-500 mt-2">💡 Совет: Выбирайте понятное название — так будет легче найти проект потом</p>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        📝 Шаг 2: Импортируйте текст
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg space-y-2 text-gray-700">
                                        <p>• Скопируйте текст вашей презентации</p>
                                        <p>• Вставьте его в большое текстовое поле</p>
                                        <p>• <span className="font-semibold">Важно!</span> Каждый слайд должен заканчиваться номером на отдельной строке</p>
                                        <p className="text-sm text-gray-600 mt-2">Пример формата:</p>
                                        <div className="bg-white p-3 rounded border border-gray-200 font-mono text-sm">
                                            Заголовок первого слайда<br/>
                                            Текст первого слайда<br/>
                                            1<br/>
                                            <br/>
                                            Заголовок второго слайда<br/>
                                            Текст второго слайда<br/>
                                            2
                                        </div>
                                        <p>• Нажмите <span className="font-semibold text-blue-600">"Импортировать слайды"</span></p>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        🎨 Шаг 3: Настройте дизайн слайдов
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg space-y-3 text-gray-700">
                                        <p className="font-semibold">Теперь самое интересное — делаем слайды красивыми!</p>
                                        
                                        <div className="ml-4 space-y-2">
                                            <p><span className="font-semibold">✏️ Редактируйте тексты:</span> В левой части можно изменить заголовок, основной текст, акцентный текст</p>
                                            <p><span className="font-semibold">📏 Меняйте размеры шрифтов:</span> Двигайте ползунки, чтобы сделать текст больше или меньше</p>
                                            <p><span className="font-semibold">🎨 Выбирайте цвета:</span> Измените цвет фона (однотонный или градиент), цвет текста, цвет выделения</p>
                                            <p><span className="font-semibold">🖼️ Добавьте картинку:</span> Можете поставить своё изображение как фон слайда</p>
                                            <p><span className="font-semibold">🔤 Выравнивание:</span> Текст можно выровнять по левому краю или по центру</p>
                                        </div>
                                        
                                        <div className="bg-yellow-50 border border-yellow-200 p-3 rounded mt-3">
                                            <p className="text-sm font-semibold text-yellow-800 mb-1">⚡ Применение изменений:</p>
                                            <p className="text-sm text-yellow-700">Когда меняете цвета или размеры, появится окошко: "Применить только к этому слайду" или "Применить к этому и следующим". Выбирайте нужный вариант!</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        💾 Шаг 4: Сохранение и экспорт
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg space-y-3 text-gray-700">
                                        <p className="font-semibold">Ваша работа сохраняется автоматически!</p>
                                        
                                        <div className="ml-4 space-y-2">
                                            <p>📱 <span className="font-semibold">Автосохранение:</span> Каждые 30 секунд данные сохраняются в вашем браузере на этом устройстве. Маленькая иконка дискеты 💾 появится внизу слева</p>
                                            <p>💻 <span className="font-semibold">Хранение:</span> Все данные хранятся только на вашем компьютере/телефоне в браузере. Никуда в интернет они не отправляются</p>
                                        </div>

                                        <div className="bg-green-50 border border-green-200 p-3 rounded">
                                            <p className="font-semibold text-green-800 mb-2">✅ Как скачать готовые слайды:</p>
                                            <div className="text-sm text-green-700 space-y-1 ml-2">
                                                <p>• <span className="font-semibold">"Скачать текущий слайд"</span> — сохранится картинка одного слайда</p>
                                                <p>• <span className="font-semibold">"Скачать все слайды ZIP"</span> — все слайды в архиве (отдельные картинки)</p>
                                                <p>• <span className="font-semibold">"Скачать все слайды PDF"</span> — один файл PDF со всеми слайдами</p>
                                                <p>• <span className="font-semibold">"Сохранить проект на диск"</span> — резервная копия со всеми текстами и настройками</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        ⚠️ Важная информация
                                    </h3>
                                    <div className="bg-red-50 p-4 rounded-lg space-y-3 text-gray-700">
                                        <div>
                                            <p className="font-semibold text-red-700 mb-2">🖼️ Фоновые изображения не сохраняются автоматически</p>
                                            <p className="text-sm">Чтобы не переполнять память браузера, картинки фона не сохраняются в автосохранении. Если закроете браузер, их придётся загрузить заново. Зато тексты и настройки никуда не денутся!</p>
                                        </div>
                                        
                                        <div>
                                            <p className="font-semibold text-orange-700 mb-2">💾 Память браузера ограничена</p>
                                            <p className="text-sm">Если память заполнится, вы увидите предупреждение. В этом случае:</p>
                                            <div className="ml-4 mt-2 text-sm space-y-1">
                                                <p>1. Скачайте резервную копию нужных проектов (кнопка 💾 рядом с проектом)</p>
                                                <p>2. Удалите старые/завершённые проекты из списка</p>
                                                <p>3. Загрузите нужный проект обратно через "Загрузить проект с диска"</p>
                                            </div>
                                        </div>

                                        <div>
                                            <p className="font-semibold text-purple-700 mb-2">🚫 Не открывайте один проект в двух вкладках</p>
                                            <p className="text-sm">Если попробуете открыть проект, который уже открыт в другой вкладке, увидите предупреждение. Закройте другую вкладку или используйте резервную копию.</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        🎬 Дополнительные функции
                                    </h3>
                                    <div className="bg-gray-50 p-4 rounded-lg space-y-2 text-gray-700 text-sm">
                                        <p>• <span className="font-semibold">➕ Добавить слайд</span> — создаёт новый пустой слайд после текущего</p>
                                        <p>• <span className="font-semibold">🗑️ Удалить слайд</span> — удаляет текущий слайд (с подтверждением)</p>
                                        <p>• <span className="font-semibold">Формат слайда</span> — на первом слайде можно выбрать: 16:9, 4:3 или квадрат 1:1</p>
                                        <p>• <span className="font-semibold">Предпросмотр</span> — справа всегда видно, как выглядит слайд</p>
                                        <p>• <span className="font-semibold">Кнопки навигации</span> — "Предыдущий" / "Следующий" для переключения между слайдами</p>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-lg">
                                    <p className="font-bold text-gray-800 text-center text-lg mb-2">🎉 Всё готово!</p>
                                    <p className="text-gray-600 text-center text-sm">
                                        Теперь вы знаете всё, чтобы создавать красивые презентации. Если что-то непонятно — всегда можно открыть эту инструкцию снова!
                                    </p>
                                </div>
                            </div>

                            <div className="sticky bottom-0 bg-white border-t border-gray-200 rounded-b-xl px-6 py-4">
                                <button
                                    onClick={() => setShowInstructions(false)}
                                    className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                >
                                    Понятно, закрыть инструкцию
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const ImageApplyModal = () => {
                if (!showImageModal) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    🖼️ Применить фоновое изображение
                                </h2>
                                
                                <div className="mb-6">
                                    <p className="text-gray-600 mb-4">
                                        Выберите, как применить это изображение:
                                    </p>
                                    
                                    {pendingImage && (
                                        <div className="mb-4 rounded-lg overflow-hidden border-2 border-gray-300">
                                            <img 
                                                src={pendingImage} 
                                                alt="Предпросмотр" 
                                                className="w-full h-48 object-cover"
                                            />
                                        </div>
                                    )}
                                </div>
                                
                                <div className="space-y-3">
                                    <button
                                        onClick={applyImageToCurrentSlide}
                                        className="w-full px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-semibold shadow-md hover:shadow-lg transform hover:scale-105 flex items-center justify-center gap-2"
                                    >
                                        <span>📄</span>
                                        Применить только для этого слайда ({currentSlideIndex + 1})
                                    </button>
                                    
                                    <button
                                        onClick={applyImageToFollowingSlides}
                                        className="w-full px-6 py-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all font-semibold shadow-md hover:shadow-lg transform hover:scale-105 flex items-center justify-center gap-2"
                                    >
                                        <span>➡️</span>
                                        Применить для этого и следующих
                                    </button>
                                    
                                    <button
                                        onClick={cancelImageUpload}
                                        className="w-full px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium border border-gray-300"
                                    >
                                        ❌ Отменить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const ImageDeleteModal = () => {
                if (!showDeleteModal) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    🗑️ Удалить фоновое изображение
                                </h2>
                                
                                <p className="text-gray-600 mb-6">
                                    Выберите область удаления:
                                </p>
                                
                                <div className="space-y-3">
                                    <button
                                        onClick={() => {
                                            removeBackgroundImage('current');
                                            setShowDeleteModal(false);
                                        }}
                                        className="w-full px-6 py-3 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-all font-semibold border-2 border-red-200 flex items-center justify-center gap-2"
                                    >
                                        <span>📄</span>
                                        Удалить только на этом слайде
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            removeBackgroundImage('following');
                                            setShowDeleteModal(false);
                                        }}
                                        className="w-full px-6 py-3 bg-orange-50 text-orange-700 rounded-lg hover:bg-orange-100 transition-all font-semibold border-2 border-orange-200 flex items-center justify-center gap-2"
                                    >
                                        <span>➡️</span>
                                        Удалить на этом и следующих
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            removeBackgroundImage('all');
                                            setShowDeleteModal(false);
                                        }}
                                        className="w-full px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all font-semibold shadow-md hover:shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <span>🗑️</span>
                                        Удалить со всех слайдов
                                    </button>
                                    
                                    <button
                                        onClick={() => setShowDeleteModal(false)}
                                        className="w-full px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium border border-gray-300"
                                    >
                                        Отмена
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const ExportProgressModal = () => {
                if (!isExporting) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
                            <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">
                                ⏳ Экспорт слайдов...
                            </h3>
                            <div className="mb-4">
                                <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                    <div 
                                        className="bg-blue-600 h-full transition-all duration-300 ease-out"
                                        style={{ width: `${exportProgress}%` }}
                                    />
                                </div>
                            </div>
                            <p className="text-center text-gray-600 font-semibold">
                                {exportProgress}%
                            </p>
                            <p className="text-center text-sm text-gray-500 mt-2">
                                Пожалуйста, подождите...
                            </p>
                        </div>
                    </div>
                );
            };

            const AutoSaveIndicator = () => {
                if (mode !== 'edit' || !isSaving) return null;
                
                return (
                    <div className="fixed bottom-4 left-4 bg-white rounded-full shadow-lg p-2 border border-gray-200 animate-fade-in-out">
                        <span className="text-xl">💾</span>
                    </div>
                );
            };

            // Экран выбора проекта
            if (mode === 'projectSelect') {
                const displayedProjects = showAllProjects ? allProjects : allProjects.slice(0, 10);
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                        <NewProjectModal />
                        <ConfirmCreateModal />
                        <ConfirmDeleteModal />
                        <SessionWarningModal />
                        <InstructionsModal />
                        
                        <div className="max-w-4xl mx-auto py-8">
                            <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
                                <div className="flex items-start justify-between mb-2">
                                    <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                                        📊 Дизайнер презентаций
                                    </h1>
                                    <button
                                        onClick={() => setShowInstructions(true)}
                                        className="px-6 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-base font-semibold border-2 border-blue-300 flex items-center gap-2 shadow-md"
                                    >
                                        📖 Инструкция
                                    </button>
                                </div>
                                <p className="text-gray-600 mb-6">
                                    Выберите проект для продолжения работы или создайте новый
                                </p>
                                
                                <button
                                    onClick={handleCreateNewProject}
                                    className="w-full bg-blue-600 text-white py-4 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 font-semibold text-lg shadow-md hover:shadow-lg mb-3"
                                >
                                    ➕ Создать новый проект
                                </button>
                                
                                <div className="relative">
                                    <input
                                        ref={importProjectFileRef}
                                        type="file"
                                        accept=".json"
                                        onChange={handleImportProjectFile}
                                        className="hidden"
                                    />
                                    <button
                                        onClick={() => importProjectFileRef.current?.click()}
                                        className="w-full bg-gray-100 text-gray-700 py-4 px-6 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center gap-2 font-semibold text-lg border-2 border-gray-300"
                                    >
                                        📂 Загрузить проект с диска
                                    </button>
                                </div>
                            </div>
                            
                            {allProjects.length > 0 && (
                                <div className="bg-white rounded-xl shadow-lg p-8">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4">
                                        Мои проекты
                                    </h2>
                                    <p className="text-sm text-gray-500 mb-6">
                                        Работа, сохранённая на этом устройстве. Вы можете продолжить редактирование или удалить завершённые проекты.
                                    </p>
                                    
                                    <div className="space-y-3">
                                        {displayedProjects.map((project, index) => (
                                            <div
                                                key={index}
                                                className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                                            >
                                                <div className="flex items-start justify-between mb-3">
                                                    <div className="flex-1">
                                                        <h3 className="font-semibold text-gray-800 mb-1 flex items-center gap-2">
                                                            📁 {project.name}
                                                        </h3>
                                                        <p className="text-sm text-gray-500">
                                                            Последнее изменение: {ProjectUtils.formatDate(project.lastModified)}
                                                        </p>
                                                        <p className="text-sm text-gray-500">
                                                            Слайдов: {project.slideCount}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => handleContinueProject(project.name)}
                                                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
                                                    >
                                                        Продолжить
                                                    </button>
                                                    <button
                                                        onClick={() => handleExportProjectFromList(project.name)}
                                                        className="px-4 py-2 bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200 transition-colors text-sm font-medium border border-gray-300"
                                                        title="Скачать резервную копию"
                                                    >
                                                        💾
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteProject(project.name)}
                                                        className="px-4 py-2 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition-colors text-sm font-medium border border-red-200"
                                                    >
                                                        Удалить
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {allProjects.length > 10 && !showAllProjects && (
                                        <button
                                            onClick={() => setShowAllProjects(true)}
                                            className="w-full mt-4 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                                        >
                                            Показать все проекты ({allProjects.length})
                                        </button>
                                    )}
                                    
                                    {showAllProjects && allProjects.length > 10 && (
                                        <button
                                            onClick={() => setShowAllProjects(false)}
                                            className="w-full mt-4 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                                        >
                                            Показать меньше
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Экран импорта
            if (mode === 'import') {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <InstructionsModal />
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-xl shadow-lg p-8">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                                            📄 Импорт слайдов
                                        </h1>
                                        <p className="text-sm text-gray-500">
                                            Проект: <span className="font-semibold">{projectName}</span>
                                        </p>
                                    </div>
                                    <button
                                        onClick={handleBackToProjects}
                                        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors flex items-center gap-2"
                                    >
                                        ← Назад к проектам
                                    </button>
                                </div>
                                
                                <p className="text-gray-600 mb-6">
                                    Вставьте текст презентации. Каждый слайд должен заканчиваться номером.
                                </p>
                                
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Текст презентации
                                    </label>
                                    <textarea
                                        ref={importTextRef}
                                        className="w-full h-96 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                                        placeholder="Вставьте сюда текст вашей презентации...&#10;&#10;Например:&#10;Психология личности:&#10;что она изучает;&#10;какие есть направления.&#10;1&#10;&#10;Каждый из нас уникален.&#10;Именно личность делает человека таким...&#10;2"
                                    />
                                </div>
                                
                                <button
                                    onClick={handleImport}
                                    className="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 font-semibold text-lg shadow-md hover:shadow-lg"
                                >
                                    ⬆️ Импортировать слайды
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Экран редактирования
            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <ImageApplyModal />
                    <ImageDeleteModal />
                    <ExportProgressModal />
                    <StorageWarningModal />
                    <SessionWarningModal />
                    <ConfirmDeleteSlideModal />
                    <InstructionsModal />
                    <AutoSaveIndicator />
                    
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                        📊 {projectName}
                                    </h1>
                                    <p className="text-sm text-gray-500">
                                        {slides.length} слайдов
                                    </p>
                                </div>
                                
                                <div className="flex items-center gap-3">
                                    <button
                                        onClick={() => setShowInstructions(true)}
                                        className="px-4 py-2 bg-yellow-50 text-yellow-700 rounded-lg hover:bg-yellow-100 transition-colors text-sm font-medium border-2 border-yellow-300 flex items-center gap-2"
                                    >
                                        ❓ Что-то непонятно? Читайте инструкцию
                                    </button>
                                    
                                    <button
                                        onClick={handleBackToProjects}
                                        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors flex items-center gap-2"
                                    >
                                        ← Назад к проектам
                                    </button>
                                </div>
                            </div>
                            
                            <div className="mb-6 bg-gray-50 p-4 rounded-lg">
                                <div className="flex items-center justify-between mb-3">
                                    <button
                                        onClick={() => setCurrentSlideIndex(Math.max(0, currentSlideIndex - 1))}
                                        disabled={currentSlideIndex === 0}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
                                    >
                                        ◀ Предыдущий
                                    </button>
                                    
                                    <div className="flex flex-col items-center gap-2">
                                        <span className="text-lg font-semibold text-gray-700">
                                            Слайд {currentSlideIndex + 1} из {slides.length}
                                        </span>
                                        
                                        <div className="flex gap-2">
                                            <button
                                                onClick={handleDeleteSlideRequest}
                                                disabled={slides.length <= 1}
                                                className="px-4 py-2 bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200 disabled:bg-gray-50 disabled:text-gray-400 disabled:cursor-not-allowed transition-colors flex items-center gap-1 text-sm"
                                            >
                                                🗑️ Удалить слайд
                                            </button>
                                            
                                            <button
                                                onClick={createNewSlide}
                                                className="px-4 py-2 bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200 transition-colors flex items-center gap-1 text-sm"
                                            >
                                                ➕ Добавить слайд
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <button
                                        onClick={() => setCurrentSlideIndex(Math.min(slides.length - 1, currentSlideIndex + 1))}
                                        disabled={currentSlideIndex === slides.length - 1}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
                                    >
                                        Следующий ▶
                                    </button>
                                </div>
                                
                                <div className="flex gap-2 overflow-x-auto pb-2">
                                    {slides.map((slide, index) => (
                                        <button
                                            key={index}
                                            onClick={() => setCurrentSlideIndex(index)}
                                            className={`flex-shrink-0 px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                                                index === currentSlideIndex
                                                    ? 'bg-blue-600 text-white'
                                                    : 'bg-white text-gray-700 hover:bg-gray-100'
                                            }`}
                                        >
                                            {index + 1}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="space-y-4">
                                    {currentSlideIndex === 0 && (
                                        <div className="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                                            <h3 className="font-semibold text-gray-700 mb-3">
                                                Формат слайдов (для всей презентации)
                                            </h3>
                                            
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Формат слайда
                                                    </label>
                                                    <select
                                                        value={aspectRatio}
                                                        onChange={(e) => setAspectRatio(e.target.value)}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 bg-white"
                                                    >
                                                        <option value="16:9">16:9 (Широкоформатный)</option>
                                                        <option value="1:1">1:1 (Квадратный)</option>
                                                        <option value="4:3">4:3 (Классический)</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <h3 className="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                            ✍️ Содержимое слайда {currentSlideIndex + 1}
                                        </h3>
                                        
                                        <div className="space-y-3">
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-medium text-gray-600">
                                                        Заголовок
                                                    </label>
                                                    <AlignmentToggle 
                                                        value={currentSlide.titleAlign} 
                                                        onChange={(value) => updateCurrentSlide('titleAlign', value)} 
                                                    />
                                                </div>
                                                <textarea
                                                    value={currentSlide.title || ''}
                                                    onChange={(e) => updateCurrentSlide('title', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    rows="2"
                                                    placeholder="Введите заголовок"
                                                />
                                            </div>
                                            
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-medium text-gray-600">
                                                        Основной текст
                                                    </label>
                                                    <AlignmentToggle 
                                                        value={currentSlide.mainTextAlign} 
                                                        onChange={(value) => updateCurrentSlide('mainTextAlign', value)} 
                                                    />
                                                </div>
                                                <textarea
                                                    value={currentSlide.mainText || ''}
                                                    onChange={(e) => updateCurrentSlide('mainText', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    rows="4"
                                                    placeholder="Введите основной текст"
                                                />
                                            </div>
                                            
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-medium text-gray-600">
                                                        Акцентный текст
                                                    </label>
                                                    <AlignmentToggle 
                                                        value={currentSlide.accentAlign} 
                                                        onChange={(value) => updateCurrentSlide('accentAlign', value)} 
                                                    />
                                                </div>
                                                <textarea
                                                    value={currentSlide.accentText || ''}
                                                    onChange={(e) => updateCurrentSlide('accentText', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    rows="2"
                                                    placeholder="Текст для выделения"
                                                />
                                            </div>
                                            
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-medium text-gray-600">
                                                        Дополнительный текст
                                                    </label>
                                                    <AlignmentToggle 
                                                        value={currentSlide.secondaryTextAlign} 
                                                        onChange={(value) => updateCurrentSlide('secondaryTextAlign', value)} 
                                                    />
                                                </div>
                                                <textarea
                                                    value={currentSlide.secondaryText || ''}
                                                    onChange={(e) => updateCurrentSlide('secondaryText', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    rows="4"
                                                    placeholder="Текст после акцента"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-100">
                                        <h3 className="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                            📏 Размеры шрифтов
                                        </h3>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <FontSizeSlider
                                                    label="Размер заголовка"
                                                    value={currentSlide.titleFontSize || 130}
                                                    onChange={(value) => {
                                                        updateCurrentSlide('titleFontSize', value);
                                                        markSettingChanged('titleFontSize');
                                                    }}
                                                    min={40}
                                                    max={150}
                                                />
                                                <ApplyButtons
                                                    settingKey="titleFontSize"
                                                    settingName="размер заголовка"
                                                    onApplyCurrent={() => {}}
                                                    onApplyAll={() => applyToCurrentAndFollowing({ titleFontSize: currentSlide.titleFontSize })}
                                                />
                                            </div>
                                            
                                            <div>
                                                <FontSizeSlider
                                                    label="Размер основного текста"
                                                    value={currentSlide.mainFontSize || 75}
                                                    onChange={(value) => {
                                                        updateCurrentSlide('mainFontSize', value);
                                                        markSettingChanged('mainFontSize');
                                                    }}
                                                    min={16}
                                                    max={150}
                                                />
                                                <ApplyButtons
                                                    settingKey="mainFontSize"
                                                    settingName="размер основного текста"
                                                    onApplyCurrent={() => {}}
                                                    onApplyAll={() => applyToCurrentAndFollowing({ mainFontSize: currentSlide.mainFontSize })}
                                                />
                                            </div>
                                            
                                            <div>
                                                <FontSizeSlider
                                                    label="Размер акцентного текста"
                                                    value={currentSlide.accentFontSize || 70}
                                                    onChange={(value) => {
                                                        updateCurrentSlide('accentFontSize', value);
                                                        markSettingChanged('accentFontSize');
                                                    }}
                                                    min={24}
                                                    max={150}
                                                />
                                                <ApplyButtons
                                                    settingKey="accentFontSize"
                                                    settingName="размер акцентного текста"
                                                    onApplyCurrent={() => {}}
                                                    onApplyAll={() => applyToCurrentAndFollowing({ accentFontSize: currentSlide.accentFontSize })}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-gray-50 rounded-lg border border-gray-200">
                                        <button
                                            onClick={() => setIsStyleSectionOpen(!isStyleSectionOpen)}
                                            className="w-full p-4 flex items-center justify-between hover:bg-gray-100 transition-colors rounded-lg"
                                        >
                                            <h3 className="font-semibold text-gray-700 flex items-center gap-2">
                                                🎨 Оформление
                                            </h3>
                                            <span className="text-2xl">{isStyleSectionOpen ? '▲' : '▼'}</span>
                                        </button>
                                        
                                        {isStyleSectionOpen && (
                                            <div className="p-4 pt-0">
                                                <div className="space-y-3">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-600 mb-1">
                                                            Тип фона
                                                        </label>
                                                        <select
                                                            value={currentSlide.bgType || 'solid'}
                                                            onChange={(e) => {
                                                                updateCurrentSlide('bgType', e.target.value);
                                                            }}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                                        >
                                                            <option value="solid">Однотонный</option>
                                                            <option value="gradient">Градиент</option>
                                                            <option value="image">Изображение</option>
                                                        </select>
                                                    </div>
                                                    
                                                    {(currentSlide.bgType || 'solid') === 'image' ? (
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-600 mb-2">
                                                                Фоновое изображение
                                                            </label>
                                                            {currentSlide.bgImage ? (
                                                                <div className="space-y-3">
                                                                    <div className="relative w-full h-32 rounded-lg overflow-hidden border-2 border-gray-300">
                                                                        <img 
                                                                            src={currentSlide.bgImage} 
                                                                            alt="Фон" 
                                                                            className="w-full h-full object-cover"
                                                                        />
                                                                    </div>
                                                                    <button
                                                                        onClick={() => setShowDeleteModal(true)}
                                                                        className="w-full px-4 py-3 bg-gradient-to-r from-red-50 to-orange-50 text-red-700 rounded-lg hover:from-red-100 hover:to-orange-100 transition-all font-semibold border-2 border-red-300 flex items-center justify-center gap-2"
                                                                    >
                                                                        🔄 Изменить фон
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <>
                                                                    <input
                                                                        ref={fileInputRef}
                                                                        type="file"
                                                                        accept="image/*"
                                                                        onChange={handleImageSelect}
                                                                        className="hidden"
                                                                    />
                                                                    <button
                                                                        onClick={() => fileInputRef.current?.click()}
                                                                        className="w-full px-4 py-8 border-2 border-dashed border-blue-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-center font-semibold text-blue-600 flex flex-col items-center justify-center gap-2"
                                                                    >
                                                                        <span className="text-4xl">📁</span>
                                                                        <span>Загрузить изображение фона</span>
                                                                    </button>
                                                                </>
                                                            )}
                                                        </div>
                                                    ) : (
                                                        <div className="space-y-3">
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-600 mb-2">
                                                                    {(currentSlide.bgType || 'solid') === 'solid' ? 'Цвет фона' : 'Цвет фона 1'}
                                                                </label>
                                                                <div className="flex gap-2">
                                                                    <input
                                                                        type="color"
                                                                        value={currentSlide.bgColor1 || '#1e40af'}
                                                                        onChange={(e) => {
                                                                            updateCurrentSlide('bgColor1', e.target.value);
                                                                            markSettingChanged('bgColor1');
                                                                        }}
                                                                        className="h-10 w-20 rounded border border-gray-300 cursor-pointer"
                                                                    />
                                                                    <input
                                                                        type="text"
                                                                        value={currentSlide.bgColor1 || '#1e40af'}
                                                                        onChange={(e) => {
                                                                            updateCurrentSlide('bgColor1', e.target.value);
                                                                            markSettingChanged('bgColor1');
                                                                        }}
                                                                        className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                                                    />
                                                                </div>
                                                                <ApplyButtons
                                                                    settingKey="bgColor1"
                                                                    settingName="цвет фона"
                                                                    onApplyCurrent={() => {}}
                                                                    onApplyAll={() => applyToCurrentAndFollowing({ bgColor1: currentSlide.bgColor1 })}
                                                                />
                                                            </div>
                                                            
                                                            {(currentSlide.bgType || 'solid') === 'gradient' && (
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-600 mb-2">
                                                                        Цвет фона 2
                                                                    </label>
                                                                    <div className="flex gap-2">
                                                                        <input
                                                                            type="color"
                                                                            value={currentSlide.bgColor2 || '#7c3aed'}
                                                                            onChange={(e) => {
                                                                                updateCurrentSlide('bgColor2', e.target.value);
                                                                                markSettingChanged('bgColor2');
                                                                            }}
                                                                            className="h-10 w-20 rounded border border-gray-300 cursor-pointer"
                                                                        />
                                                                        <input
                                                                            type="text"
                                                                            value={currentSlide.bgColor2 || '#7c3aed'}
                                                                            onChange={(e) => {
                                                                                updateCurrentSlide('bgColor2', e.target.value);
                                                                                markSettingChanged('bgColor2');
                                                                            }}
                                                                            className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                                                        />
                                                                    </div>
                                                                    <ApplyButtons
                                                                        settingKey="bgColor2"
                                                                        settingName="второй цвет фона"
                                                                        onApplyCurrent={() => {}}
                                                                        onApplyAll={() => applyToCurrentAndFollowing({ bgColor2: currentSlide.bgColor2 })}
                                                                    />
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                    
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-600 mb-2">
                                                            Цвет текста
                                                        </label>
                                                        <div className="flex gap-2">
                                                            <input
                                                                type="color"
                                                                value={currentSlide.textColor || '#ffffff'}
                                                                onChange={(e) => {
                                                                    updateCurrentSlide('textColor', e.target.value);
                                                                    markSettingChanged('textColor');
                                                                }}
                                                                className="h-10 w-20 rounded border border-gray-300 cursor-pointer"
                                                            />
                                                            <input
                                                                type="text"
                                                                value={currentSlide.textColor || '#ffffff'}
                                                                onChange={(e) => {
                                                                    updateCurrentSlide('textColor', e.target.value);
                                                                    markSettingChanged('textColor');
                                                                }}
                                                                className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                                            />
                                                        </div>
                                                        <ApplyButtons
                                                            settingKey="textColor"
                                                            settingName="цвет текста"
                                                            onApplyCurrent={() => {}}
                                                            onApplyAll={() => applyToCurrentAndFollowing({ textColor: currentSlide.textColor })}
                                                        />
                                                    </div>
                                                    
                                                    <div className="space-y-3 mt-4 pt-4 border-t border-gray-200">
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-600 mb-2">
                                                                Цвет акцентной подложки
                                                            </label>
                                                            <div className="flex gap-2">
                                                                <input
                                                                    type="color"
                                                                    value={currentSlide.accentBgColor || '#fbbf24'}
                                                                    onChange={(e) => {
                                                                        updateCurrentSlide('accentBgColor', e.target.value);
                                                                        markSettingChanged('accentBgColor');
                                                                    }}
                                                                    className="h-10 w-20 rounded border border-gray-300 cursor-pointer"
                                                                />
                                                                <input
                                                                    type="text"
                                                                    value={currentSlide.accentBgColor || '#fbbf24'}
                                                                    onChange={(e) => {
                                                                        updateCurrentSlide('accentBgColor', e.target.value);
                                                                        markSettingChanged('accentBgColor');
                                                                    }}
                                                                    className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                                                />
                                                            </div>
                                                            <ApplyButtons
                                                                settingKey="accentBgColor"
                                                                settingName="цвет акцентной подложки"
                                                                onApplyCurrent={() => {}}
                                                                onApplyAll={() => applyToCurrentAndFollowing({ accentBgColor: currentSlide.accentBgColor })}
                                                            />
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-600 mb-2">
                                                                Цвет текста на акценте
                                                            </label>
                                                            <div className="flex gap-2">
                                                                <input
                                                                    type="color"
                                                                    value={currentSlide.accentTextColor || '#000000'}
                                                                    onChange={(e) => {
                                                                        updateCurrentSlide('accentTextColor', e.target.value);
                                                                        markSettingChanged('accentTextColor');
                                                                    }}
                                                                    className="h-10 w-20 rounded border border-gray-300 cursor-pointer"
                                                                />
                                                                <input
                                                                    type="text"
                                                                    value={currentSlide.accentTextColor || '#000000'}
                                                                    onChange={(e) => {
                                                                        updateCurrentSlide('accentTextColor', e.target.value);
                                                                        markSettingChanged('accentTextColor');
                                                                    }}
                                                                    className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                                                />
                                                            </div>
                                                            <ApplyButtons
                                                                settingKey="accentTextColor"
                                                                settingName="цвет текста на акценте"
                                                                onApplyCurrent={() => {}}
                                                                onApplyAll={() => applyToCurrentAndFollowing({ accentTextColor: currentSlide.accentTextColor })}
                                                            />
                                                        </div>
                                                    </div>
                                                    
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-600 mb-1">
                                                            Шрифт
                                                        </label>
                                                        <select
                                                            value={currentSlide.fontFamily || 'Inter'}
                                                            onChange={(e) => {
                                                                updateCurrentSlide('fontFamily', e.target.value);
                                                                markSettingChanged('fontFamily');
                                                            }}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                                        >
                                                            {fonts.map(font => (
                                                                <option key={font.name} value={font.name}>
                                                                    {font.name}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        <ApplyButtons
                                                            settingKey="fontFamily"
                                                            settingName="шрифт"
                                                            onApplyCurrent={() => {}}
                                                            onApplyAll={() => applyToCurrentAndFollowing({ fontFamily: currentSlide.fontFamily })}
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="space-y-2">
                                        <button
                                            onClick={exportCurrentSlide}
                                            className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 font-medium shadow-md hover:shadow-lg"
                                        >
                                            ⬇️ Скачать текущий слайд
                                        </button>
                                        
                                        <button
                                            onClick={exportAllSlidesAsZip}
                                            disabled={isExporting}
                                            className="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2 font-medium shadow-md hover:shadow-lg"
                                        >
                                            📦 Скачать все слайды ZIP ({slides.length})
                                        </button>
                                        
                                        <button
                                            onClick={exportAllSlidesAsPDF}
                                            disabled={isExporting}
                                            className="w-full bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2 font-medium shadow-md hover:shadow-lg"
                                        >
                                            📄 Скачать все слайды PDF ({slides.length})
                                        </button>
                                        
                                        <div className="pt-2 border-t border-gray-200">
                                            <button
                                                onClick={exportProjectToFile}
                                                className="w-full bg-gray-100 text-gray-600 py-3 px-4 rounded-md hover:bg-gray-200 transition-colors flex items-center justify-center gap-2 font-medium border border-gray-300"
                                            >
                                                💾 Сохранить проект на диск
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div className="sticky top-4">
                                        <label className="block text-sm font-medium text-gray-600 mb-2">
                                            Предпросмотр слайда {currentSlideIndex + 1}
                                        </label>
                                        <div className="bg-gray-200 p-4 rounded-lg">
                                            <div
                                                ref={slideRef}
                                                className={`${getAspectRatioClass()} rounded-lg shadow-xl overflow-hidden`}
                                                style={getSlideBackground()}
                                            >
                                                <div className="h-full flex flex-col justify-center p-12">
                                                    {currentSlide.title && (
                                                        <h2
                                                            className={`font-bold mb-6 ${
                                                                currentSlide.titleAlign === 'left' ? 'self-start text-left' : 'self-center text-center'
                                                            }`}
                                                            style={{
                                                                fontFamily: fonts.find(f => f.name === (currentSlide.fontFamily || 'Inter'))?.value,
                                                                color: currentSlide.textColor || '#ffffff',
                                                                fontSize: `${(currentSlide.titleFontSize || 130) * 0.25}px`,
                                                                whiteSpace: 'pre-wrap'
                                                            }}
                                                        >
                                                            {currentSlide.title}
                                                        </h2>
                                                    )}
                                                    
                                                    {currentSlide.mainText && (
                                                        <p
                                                            className={`mb-6 max-w-2xl ${
                                                                currentSlide.mainTextAlign === 'left' ? 'self-start text-left' : 'self-center text-center'
                                                            }`}
                                                            style={{
                                                                fontFamily: fonts.find(f => f.name === (currentSlide.fontFamily || 'Inter'))?.value,
                                                                color: currentSlide.textColor || '#ffffff',
                                                                opacity: 0.9,
                                                                fontSize: `${(currentSlide.mainFontSize || 75) * 0.25}px`,
                                                                whiteSpace: 'pre-wrap'
                                                            }}
                                                        >
                                                            {currentSlide.mainText}
                                                        </p>
                                                    )}
                                                    
                                                    {currentSlide.accentText && (
                                                        <div className={`mb-6 ${
                                                            currentSlide.accentAlign === 'left' ? 'self-start' : 'self-center'
                                                        }`}>
                                                            <div className="relative inline-block">
                                                                <div
                                                                    className="absolute inset-0 rounded-lg"
                                                                    style={{
                                                                        backgroundColor: currentSlide.accentBgColor || '#fbbf24',
                                                                        margin: `-${(currentSlide.accentFontSize || 70) * 0.15}px -${(currentSlide.accentFontSize || 70) * 0.3}px`
                                                                    }}
                                                                />
                                                                <p
                                                                    className="relative font-semibold"
                                                                    style={{
                                                                        fontFamily: fonts.find(f => f.name === (currentSlide.fontFamily || 'Inter'))?.value,
                                                                        color: currentSlide.accentTextColor || '#000000',
                                                                        fontSize: `${(currentSlide.accentFontSize || 70) * 0.25}px`,
                                                                        padding: `${(currentSlide.accentFontSize || 70) * 0.15}px ${(currentSlide.accentFontSize || 70) * 0.3}px`,
                                                                        whiteSpace: 'pre-wrap'
                                                                    }}
                                                                >
                                                                    {currentSlide.accentText}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {currentSlide.secondaryText && (
                                                        <p
                                                            className={`max-w-2xl ${
                                                                currentSlide.secondaryTextAlign === 'left' ? 'self-start text-left' : 'self-center text-center'
                                                            }`}
                                                            style={{
                                                                fontFamily: fonts.find(f => f.name === (currentSlide.fontFamily || 'Inter'))?.value,
                                                                color: currentSlide.textColor || '#ffffff',
                                                                opacity: 0.9,
                                                                fontSize: `${(currentSlide.mainFontSize || 75) * 0.25}px`,
                                                                whiteSpace: 'pre-wrap'
                                                            }}
                                                        >
                                                            {currentSlide.secondaryText}
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<PresentationDesigner />, document.getElementById('root'));
    </script>
</body>
</html>
